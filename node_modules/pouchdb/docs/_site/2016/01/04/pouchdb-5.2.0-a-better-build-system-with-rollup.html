<!DOCTYPE html>
<html lang="en" manifest="/manifest.appcache">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PouchDB 5.2.0&#58; A better build system with Rollup</title>
    <link rel="alternate" title="PouchDB, the JavaScript Database that Syncs!" type="application/rss+xml" href="/feed.xml">
    <link rel="stylesheet" href="/static/css/pouchdb.css" />
    <meta name="theme-color" content="#6ccb99">
    <meta name="msapplication-TileColor" content="#6ccb99">
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-42479701-1']);
      _gaq.push(['_trackPageview']);

      (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    <link href='http://fonts.googleapis.com/css?family=Lato:400,700|Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon"/>
  </head>

  <body data-spy="scroll" data-target="#sidebar">

    <header role="banner">

      <a href="https://github.com/pouchdb/pouchdb" target="_blank">
         <div class="ribbon">GitHub</div>
      </a>

      <div class="container">

        <a class="logo" href="/">
          <div class="logo-img"></div>
          <span class='logo-type'>PouchDB</span>
        </a>

        <ul class='nav nav-header nav-pills' role="navigation">
          <li>
            <a class='btn btn-link btn-lg' href="/blog/">Blog</a>
          </li>
          <li>
            <a class='btn btn-link btn-lg' href="/guides/">Guides</a>
          </li>
          <li>
            <a class='btn btn-link btn-lg' href="/api.html">API</a>
          </li>
          <li>
            <a class='btn btn-link btn-lg' href="/learn.html">Learn</a>
          </li>
          <li>
            <a
                class='btn btn-primary btn-lg'
                href="https://github.com/pouchdb/pouchdb/releases/download/5.2.0/pouchdb-5.2.0.min.js"
            >
                Download <strong>v5.2.0</strong>
            </a>
          </li>
        </ul>

      </div>

    </header>
    
      <div class="page-head">

        <div class="container">

          <h1 class="page-title">PouchDB 5.2.0&#58; A better build system with Rollup</h1>
          
            <span class="h1">
              
  

<a
  data-toggle="tooltip"
  data-placement="top"
  title="Edit this on Github"
  class="icon-edit"
  href="https://github.com/pouchdb/pouchdb/edit/master/docs/_posts/2016-01-04-pouchdb-5.2.0-a-better-build-system-with-rollup.md"
  target="_blank"
></a>

            </span>
          
          

        </div>

      </div>
    

    <div role="main">
      <article class='container'>
  <div class='row'>
    <article class='col-md-offset-1 col-md-10' role="article">
      
  







  

  
    
      
    
    
      
    
  

  

  

  




<div class="post">
  <div class="media">
    <a class="pull-left" href="#">
    <img class="media-object img-circle img-responsive" src='https://gravatar.com/avatar/c436dec61b906e27c963518d0ef1d972' alt='Nolan Lawson'>
    </a>
    <div class="media-body">
    <p>
      <strong>By:</strong> <a href="https://twitter.com/nolanlawson">Nolan Lawson</a><br>
      <strong>Published:</strong> 04 January 2016<br>
      
    </p>
    </div>
  </div>
</div>


      <blockquote>
<p>&quot;Rollup! Rollup for the mystery tour!&quot;
- Lennon and McCartney</p>
</blockquote>

<p>Besides a slew of bugfixes and the new <code>revs_limit</code> feature, the big news about 5.2.0 is that PouchDB is now authored with ES6 modules rather than CommonJS. Using <a href="http://rollupjs.org/">Rollup</a>, it&#39;s transpiled into one big <code>index.js</code> for Node and an <code>index-browser.js</code> for Webpack/Browserify.</p>

<p>The most immediate benefit is that PouchDB&#39;s minified/gzipped size has dropped by 3KB (6.7% smaller!) with no loss of functionality. This is thanks to Rollup&#39;s ability to remove the typical Browserify/Webpack cruft by <a href="https://github.com/nolanlawson/rollup-comparison">hoisting all submodules into a single scope</a>.</p>

<p>Another benefit is that PouchDB is now insulated from subtle differences between build systems like Browserify, Webpack, Babel, and Rollup itself. This is an esoteric problem for JavaScript library authors, but I think it&#39;s worth going into detail, because it affects more libraries than just PouchDB.</p>

<p>I&#39;ll explore that topic later in the post, but first, here&#39;s the full changelog for 5.2.0:</p>

<h3>Changelog</h3>

<h4>Features and improvements</h4>

<ul>
<li>Implement <code>revs_limit</code> (<a href="https://github.com/pouchdb/pouchdb/issues/2839">#2839</a>)</li>
<li>Migrate to ES6/Rollup, build one <code>index.js</code> (<a href="https://github.com/pouchdb/pouchdb/issues/4652">#4652</a>)</li>
<li>Add ability to disable timeout in <code>changes()</code> (<a href="https://github.com/pouchdb/pouchdb/issues/4583">#4583</a>)</li>
</ul>

<h4>Bugfixes</h4>

<ul>
<li>Return conflict error when inserting an unknown rev (<a href="https://github.com/pouchdb/pouchdb/issues/4712">#4712</a>)</li>
<li>Catch XHR errors and propagate (<a href="https://github.com/pouchdb/pouchdb/issues/4595">#4595</a>)</li>
<li>Fix and test Webpack (<a href="https://github.com/pouchdb/pouchdb/issues/4700">#4700</a>)</li>
<li>Improve error when user sends invalid base64 (<a href="https://github.com/pouchdb/pouchdb/issues/4208">#4208</a>)</li>
<li>Consider changes erroring a valid result (<a href="https://github.com/pouchdb/pouchdb/issues/4677">#4677</a>)</li>
<li>Allow bulkGet requests without an explicit rev (<a href="https://github.com/pouchdb/pouchdb/issues/4530">#4530</a>) </li>
<li>Fix for xhr.upload detection failing (<a href="https://github.com/pouchdb/pouchdb/issues/4560">#4560</a>)</li>
<li>Coerce options which should be numbers to number (<a href="https://github.com/pouchdb/pouchdb/issues/4578">#4578</a>)</li>
<li>Add timeout option to replication (<a href="https://github.com/pouchdb/pouchdb/issues/4540">#4540</a>)</li>
<li>Remove binary string conversion (<a href="https://github.com/pouchdb/pouchdb/issues/4529">#4529</a>)</li>
<li>Remove CORS explanation (<a href="https://github.com/pouchdb/pouchdb/issues/4677">#4677</a>)</li>
<li>Add browser sniffing and remove nonce by default (<a href="https://github.com/pouchdb/pouchdb/issues/4543">#4543</a>)</li>
<li>Remove unneeded host.headers from ajax (<a href="https://github.com/pouchdb/pouchdb/issues/4567">#4567</a>)</li>
<li>Fix double-encoding name in http adapter (<a href="https://github.com/pouchdb/pouchdb/issues/4514">#4514</a>)</li>
<li>Fix and document heartbeat for replication (<a href="https://github.com/pouchdb/pouchdb/issues/4538">#4538</a>)</li>
<li>Fallback from <code>_bulk_get</code> on 50x requests (<a href="https://github.com/pouchdb/pouchdb/issues/4542">#4542</a>)</li>
<li>Remove Cordova init checks (<a href="https://github.com/pouchdb/pouchdb/issues/4756">#4756</a>)</li>
<li>Reset <code>changedDocs</code> in <code>write_docs</code> (<a href="https://github.com/pouchdb/pouchdb/issues/4627">#4627</a>)</li>
</ul>

<h3>PouchDB and JavaScript build systems</h3>

<p>To explain why we&#39;re now using Rollup to bundle one big <code>index.js</code> for Node, we&#39;ll need to take a look at the open-source JavaScript landscape, as it stands in 2016.</p>

<p>I&#39;ve been working on PouchDB for about two years. In that short amount of time, I&#39;ve seen the frontend ecosystem largely transition from prebuilt <code>&lt;script&gt;</code>-ready JavaScript files, usually distributed via Bower, CDN, or direct download, to Node modules distributed by npm and directly consumed by build tools like Browserify, Webpack, Babel, Grunt, Gulp, etc.</p>

<p>A big impact of this is that library authors no longer have control over the &quot;last mile.&quot; Whereas our code used to be plopped directly into an HTML page (or merely concatenated), nowadays it&#39;s often parsed, chopped up, and transformed before it reaches that HTML page. This process inevitably introduces bugs and inconsistencies.</p>

<p>For instance, PouchDB has been <a href="https://gist.github.com/nolanlawson/e5e3b3856f1a8347f277">struggling with Webpack support</a> for much of the past year. The number of times we&#39;ve had Webpack-related bugs filed on us, and the number of times we&#39;ve later regressed because we only test with Browserify, eventually compelled us to <a href="https://github.com/pouchdb/pouchdb/pull/4701">test Webpack separately</a>. This means we&#39;re essentially testing both Browserify and Webpack as build targets.</p>

<p>Think this sounds extreme? Consider this example.</p>

<h4>Example 1: requiring JSON</h4>

<p>Let&#39;s say you added this seemingly-innocuous line of code to your JavaScript library:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">MyLibrary</span><span class="p">.</span><span class="nx">version</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./package.json&#39;</span><span class="p">).</span><span class="nx">version</span><span class="p">;</span>
</code></pre></div>
<p>This will work in Browserify and Node, but it will break in Webpack unless the end-user adds a special <a href="https://github.com/webpack/json-loader">json-loader</a> to their Webpack configuration. </p>

<p>Does your library do this? Do you have a <em>dependency</em> that does this? Then congratulations, you cannot fix this for your users. All you can do is document it in your README and/or endure the inevitable bug reports.</p>

<p>This is not something Webpack intends to fix, since it seems to constitute a philosophical difference between Browserify and Webpack. Their argument is that end-users should have control over how libraries are built. (You can read <a href="https://github.com/webpack/webpack/issues/378">this discussion</a> for details.)</p>

<h4>Example 2: Browserify transforms</h4>

<p>Another good example of Browserify/Webpack differences is <a href="https://github.com/substack/node-browserify/wiki/list-of-transforms">Browserify transforms</a>. These are modules that can transform your library at build time, when it&#39;s consumed by Browserify.</p>

<p>Transforms are very popular in the Browserify ecosystem, but unfortunately they don&#39;t work in Webpack unless you use the <a href="https://github.com/webpack/transform-loader">transform-loader</a>. Worse, this is another thing that end-users are expected to configure for every dependency (and every dependency of a dependency&hellip;).</p>

<p>So if your project is built with Browserify, it&#39;s easy to accidentally add a Browserify transform, while forgetting that it will break for Webpack users. (We nearly made that mistake ourselves, before we started testing Webpack.) So the only reasonable choice for library authors is to avoid Browserify transforms entirely.</p>

<h4>Example 3: strict mode</h4>

<p>To stop picking on Webpack for a bit, I also <a href="http://nolanlawson.com/2015/12/28/how-to-fix-a-bug-in-an-open-source-project/">recently blogged about a bug</a> in the <a href="https://github.com/feross/buffer">&quot;buffer&quot; project</a> that was caused by Babel re-interpreting the code as strict, even though it was not distributed in strict mode. This is another great example of a &quot;last mile&quot; bug that ended up being something the library author needed to deal with.</p>

<p>Of course, in this case, the library author could have just said &quot;not my bug.&quot; But then the Babel authors might have (quite reasonably) responded, &quot;your library should be strict; we don&#39;t support non-strict code,&quot; at which point it would become a game of hot potato. And all the while, end-users would be adding messy hacks to their build scripts to work around the issue.</p>

<h4>Lessons from the browser world</h4>

<p>This story should be familiar. We&#39;ve been here before. JavaScript developers have always had to struggle with a hostile and unpredictable environment, which required us to write robust code that could anticipate bugs and implementation differences. Of course, I&#39;m talking about the browser.</p>

<p>Now, I won&#39;t argue that writing code for Browserify, Webpack, Babel, and friends is nearly as difficult as writing code for a half-dozen browsers, but it&#39;s definitely getting there. So in my opinion, the only reasonable solution is to start bundling code before distribution on NPM, which is desirable anyway since we have so many nice tools for transpiling future JavaScript to browser-safe ES5 (such as Babel itself).</p>

<p>The benefits are clear: we can use Browserify transforms and <code>require(&#39;./package.json&#39;)</code> and whatever else we want, as long as they&#39;re only <em>compile steps</em> that build a bundle to be consumed by Node (and therefore Browserify/Webpack). As a bonus, this allows us to build a smaller and sleeker bundle, which is also faster for the end-user to build, since most of the build steps have already been run in advance.</p>

<p>I believe most JavaScript libraries are already moving in this direction, so this puts PouchDB firmly in that bandwagon. But to be clear: we don&#39;t intend to start using all the various experimental ES6/ES7 features in PouchDB. In fact, we are <em>only</em> transforming ES6 modules into CommonJS ; in all other ways, PouchDB is still standard ES5. The reason we&#39;re doing this is that transpiled ES5 is often cruftier than hand-written ES5. So for now, we&#39;re avoiding it.</p>

<p>The goal of implementing CouchDB in JavaScript has always been an ambitious one. The fact that we&#39;ve done so in ~45KB is an even more impressive accomplishment. But despite the challenges, we&#39;re going to keep the bar high; we even have <a href="https://github.com/pouchdb/pouchdb/blob/541867814da313855bd802cdc87cce8fcfb12320/bin/verify-bundle-size.sh">a CI test</a> that fails if our minified bundle ever exceeds 50KB.</p>

<p>Along those same lines, we also have an <a href="https://github.com/pouchdb/pouchdb/issues/4449">open issue</a> to add the ability to create custom builds (e.g. no WebSQL, no map/reduce, no replication, etc.). Presumably this can be made even easier with Rollup&#39;s tree-shaking capabilities, but we&#39;re still investigating this feature.</p>

<h3>Get in touch</h3>

<p>As always, please <a href="https://github.com/pouchdb/pouchdb/issues">file issues</a> or <a href="https://github.com/pouchdb/pouchdb/blob/master/CONTRIBUTING.md#get-in-touch">tell us what you think</a>. And as always, a big thanks to all of our <a href="https://github.com/pouchdb/pouchdb/graphs/contributors">new and existing contributors</a>!</p>

    </article>
  </div>
</article>

    </div>

    <div class="icons">

      <div class="container">

        <div class="row">

          <div class='col-xs-4 col-md-offset-0 col-md-2'>
            <a href='https://twitter.com/pouchdb' target='_blank'>
              <div class="icon icon-twitter"></div>
              <span class="sr-only">PouchDB's Twitter</span>
            </a>
          </div>

          <div class='col-xs-4 col-md-2'>
            <a href='https://github.com/rvagg/node-levelup' target='_blank'>
              <div class="icon icon-leveldb"></div>
              <span class="sr-only">Node Levelup</span>
            </a>
          </div>

          <div class='col-xs-4 col-md-2'>
            <a href='https://github.com/pouchdb/pouchdb' target='_blank'>
              <div class="icon icon-github"></div>
              <span class="sr-only">PouchDB's Github Repo</span>
            </a>
            </div>

          <div class='col-xs-4 col-md-offset-0 col-md-2'>
            <a href='https://travis-ci.org/pouchdb/pouchdb' target='_blank'>
              <div class="icon icon-travis"></div>
              <span class="sr-only">PouchDB's Travis CI</span>
            </a>
          </div>

          <div class='col-xs-4 col-md-2'>
            <a href='http://couchdb.apache.org/' target='_blank'>
              <div class="icon icon-couchdb"></div>
              <span class="sr-only">CouchDB</span>
            </a>
          </div>

          <div class='col-xs-4 col-md-2'>
            <a href='https://saucelabs.com' target='_blank'>
              <div class="icon icon-saucelabs"></div>
              <span class="sr-only">Saucelabs</span>
            </a>
          </div>

        </div>

      </div>

    </div>

    <footer class="footer">

      <div class="container">

        <div class="row">

          <div class='col-sm-3'>
            <h3 class="nav-head">Learn</h3>
            <ul class='nav nav-silent'>
              <li><a href="/getting-started.html">Getting Started</a></li>
              <li><a href="/api.html">API Guide</a></li>
              <li><a href="https://github.com/pouchdb/pouchdb/wiki">Wiki</a></li>
            </ul>
          </div>

          <div class='col-sm-3'>
            <h3 class="nav-head">Discuss</h3>
            <ul class='nav nav-silent'>
              <li><a href="https://groups.google.com/forum/#!forum/pouchdb">Mailing List</a></li>
              <li><a href="irc://freenode.net/#pouchdb">IRC</a></li>
              <li><a href="http://twitter.com/pouchdb">Twitter</a></li>
              <li><a href="http://stackoverflow.com/questions/tagged/pouchdb">StackOverflow</a></li>
            </ul>
          </div>

          <div class='col-sm-3'>
            <h3 class="nav-head">Contribute</h3>
            <ul class='nav nav-silent'>
              <li><a href="https://github.com/pouchdb/pouchdb/blob/master/CONTRIBUTING.md">Contributing</a></li>
              <li><a href="https://github.com/pouchdb/pouchdb">Source</a></li>
              <li><a href="https://github.com/pouchdb/pouchdb/issues">Issues</a></li>
              <li><a href="https://github.com/pouchdb/pouchdb/blob/master/LICENSE">Apache License</a></li>
            </ul>
          </div>

        </div>

      </div>

    </footer>
    <script type="text/javascript" src="http://code.jquery.com/jquery.min.js"></script>
    <script type="text/javascript" src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/static/js/code.min.js"></script>
    <script type="text/javascript" src="/static/js/stickyfill.min.js"></script>
    <script type="text/javascript" src="http://cdn.jsdelivr.net/pouchdb/latest/pouchdb.min.js"></script>
    <script type="text/javascript">
      var $navSidebarWrapper = $('.nav-sidebar-wrapper');
      if ($navSidebarWrapper.length) {
        $navSidebarWrapper.Stickyfill();
      }
      $('[data-toggle="tooltip"]').tooltip();
      function onCached(e) {
        if (applicationCache.status === 1) {
          giveIntro();
        }
      }

      function giveIntro() {
        console.log('%c\n..............................................................................\n.?I...........~+: ............................................................\n.???.........++++.............................................................\n:????+......+++++.............................................................\n.??????+++++++++:.................................H...........D..B............\n...????++++++++...................................H...........D..B............\n...=????++++++.......PPPPP...OOOO...U....U...CCCC.HHHHH...DDDDD..BBBBB........\n...?????+++++++......P...:P.OO...O..U....U..C.....H...H..D....D..B....B.......\n..???????+++++++ ....P. ..P.O....O..U....U.CC.....H...H..D....D..B....B.......\n..?????????????......P...:P.OO...O..U....U..C.....H...H..D....D..B....B.......\n...I??????????~......PPPPP...OOOO...=UUUUU...CCCC.H...H...DDDDD..BBBBB........\n....?????????~.......P.... ...................................................\n.....???????+........P........................................................\n......??????..................................................................\n..............................................................................\n..............................................................................\n..............................................................................', 'color: #4ec084');
        console.log('%c\nPouchDB itself is hosted at PouchDB.com!\nTo get started, try typing:\nvar db = new PouchDB(\'mydb\');', 'color: #4ec084');
      }
      function offerToReload() {
        $('.js-update-notification')
          .removeClass('btn-update-hidden')
          .on('click', function(){
            window.location.reload();
          });
      }
      if (window.applicationCache) {
        applicationCache.addEventListener('cached', onCached, false);
        applicationCache.addEventListener('noupdate', giveIntro, false);
        applicationCache.addEventListener('updateready', offerToReload, false);
      }
    </script>
    <button type="button" class="js-update-notification btn btn-primary btn-update btn-update-hidden">
      Content updated, reload now? ↻
    </button>
  </body>
</html>
