<!DOCTYPE html>
<html lang="en" manifest="/manifest.appcache">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Changes feed</title>
    <link rel="alternate" title="PouchDB, the JavaScript Database that Syncs!" type="application/rss+xml" href="/feed.xml">
    <link rel="stylesheet" href="/static/css/pouchdb.css" />
    <meta name="theme-color" content="#6ccb99">
    <meta name="msapplication-TileColor" content="#6ccb99">
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-42479701-1']);
      _gaq.push(['_trackPageview']);

      (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    <link href='http://fonts.googleapis.com/css?family=Lato:400,700|Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon"/>
  </head>

  <body data-spy="scroll" data-target="#sidebar">

    <header role="banner">

      <a href="https://github.com/pouchdb/pouchdb" target="_blank">
         <div class="ribbon">GitHub</div>
      </a>

      <div class="container">

        <a class="logo" href="/">
          <div class="logo-img"></div>
          <span class='logo-type'>PouchDB</span>
        </a>

        <ul class='nav nav-header nav-pills' role="navigation">
          <li>
            <a class='btn btn-link btn-lg' href="/blog/">Blog</a>
          </li>
          <li>
            <a class='btn btn-link btn-lg' href="/guides/">Guides</a>
          </li>
          <li>
            <a class='btn btn-link btn-lg' href="/api.html">API</a>
          </li>
          <li>
            <a class='btn btn-link btn-lg' href="/learn.html">Learn</a>
          </li>
          <li>
            <a
                class='btn btn-primary btn-lg'
                href="https://github.com/pouchdb/pouchdb/releases/download/5.2.0/pouchdb-5.2.0.min.js"
            >
                Download <strong>v5.2.0</strong>
            </a>
          </li>
        </ul>

      </div>

    </header>
    
      <div class="page-head">

        <div class="container">

          <h1 class="page-title">Changes feed</h1>
          
            <span class="h1">
              
  

<a
  data-toggle="tooltip"
  data-placement="top"
  title="Edit this on Github"
  class="icon-edit"
  href="https://github.com/pouchdb/pouchdb/edit/master/docs/_guides/changes.md"
  target="_blank"
></a>

            </span>
          
          

        </div>

      </div>
    

    <div role="main">
      <article>
  <div class="container">
    <div class="row">
        <div id="sidebar" class="col-sm-3 nav-sidebar-wrapper">
          <ul class="nav nav-silent nav-sidebar" role="navigation">
            

    
    
        
    
    <li >
    <a href="/guides/">Intro</a>
</li>


    
    
    <li >
    <a href="/guides/setup-couchdb.html">Setting up CouchDB</a>
</li>


    
    
    <li >
    <a href="/guides/setup-pouchdb.html">Setting up PouchDB</a>
</li>


    
    
    <li >
    <a href="/guides/databases.html">Working with databases</a>
</li>


    
    
    <li >
    <a href="/guides/documents.html">Working with documents</a>
</li>


    
    
    <li >
    <a href="/guides/async-code.html">Asynchronous code</a>
</li>


    
    
        
    
    <li >
    <a href="/guides/updating-deleting.html">Updating/deleting documents</a>
</li>


    
    
    <li >
    <a href="/guides/bulk-operations.html">Bulk operations</a>
</li>


    
    
    <li >
    <a href="/guides/attachments.html">Working with attachments</a>
</li>


    
    
    <li >
    <a href="/guides/replication.html">Replication</a>
</li>


    
    
    <li >
    <a href="/guides/conflicts.html">Conflicts</a>
</li>


    
    
    <li  class="active" >
    <a href="/guides/changes.html">Changes feed</a>
</li>


    
    
    <li >
    <a href="/guides/queries.html">Map/reduce queries</a>
</li>


    
    
    <li >
    <a href="/guides/compact-and-destroy.html">Compacting and destroying</a>
</li>


    
    
    <li >
    <a href="/guides/local-documents.html">Local documents</a>
</li>



          </ul>
        </div>

        <div class="col-sm-9" role="main">
          <p>One of the brilliant things about CouchDB replication is that it makes it easy to learn about changes made to the database over time. CouchDB allows you to easily answer questions like:</p>

<ul>
<li>What changes occurred to the database since a given time?</li>
<li>What changes occurred to this document?</li>
<li>What did this database look like a few days ago?</li>
</ul>

<p>For all of these and related questions, there&#39;s the <code>changes()</code> API.</p>

<div id='basic-changes-usage'></div>

<p><a class='h2 anchor' href='#basic-changes-usage' name='basic-changes-usage'>
Basic changes usage
</a></p>

<p>If you want to simply fetch all changes since the beginning of time, you can do:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">db</span><span class="p">.</span><span class="nx">changes</span><span class="p">({</span>
  <span class="nx">since</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="nx">include_docs</span><span class="o">:</span> <span class="kc">true</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">changes</span><span class="p">)</span> <span class="p">{</span>

<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// handle errors</span>
<span class="p">});</span>
</code></pre></div>
<p>You can see a <strong><a href="http://bl.ocks.org/nolanlawson/7c32861af5d31a8fac4a">live example</a></strong> of this code.</p>

<p>Then you will have a list of all changes made to the database, in the order that they were made.</p>

<p>One thing you will notice about the changes feed is that it actually omits non-leaf revisions to documents. For instance, in the live example, we skip from <code>seq</code> 1 immediately to <code>seq</code> 3.</p>

<p>This is by design &ndash; the changes feed only tells us about leaf revisions. However, the order of those leaf revisions is determined by the order they were put in the database. So you may notice that <code>&#39;firstDoc&#39;</code> still appears before <code>&#39;secondDoc&#39;</code>, which appears before <code>&#39;thirdDoc&#39;</code>.</p>

<p>Also notice the the option <code>{include_docs: true}</code>. By default, the documents themselves are not included in the changes feed; only the <code>id</code>s, <code>rev</code>s, and whether or not they were <code>deleted</code>. With <code>{include_docs: true}</code>, however, each non-deleted change will have a <code>doc</code> property containing the new or modified document.</p>

<div id='changes-pagination'></div>

<p><a class='h2 anchor' href='#changes-pagination' name='changes-pagination'>
Changes pagination
</a></p>

<p>If you expect this to be a very large number of changes, you can also use the <code>limit</code> option to do pagination:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">pageSize</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">lastSeq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kd">function</span> <span class="nx">fetchNextPage</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nx">changes</span><span class="p">({</span>
    <span class="nx">since</span><span class="o">:</span> <span class="nx">lastSeq</span><span class="p">,</span>
    <span class="nx">limit</span><span class="o">:</span> <span class="nx">pageSize</span>
  <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">changes</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">changes</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">pageSize</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// done!</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">lastSeq</span> <span class="o">=</span> <span class="nx">changes</span><span class="p">.</span><span class="nx">last_seq</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">fetchNextPage</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="nx">fetchNextPage</span><span class="p">().</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// handle errors</span>
<span class="p">});</span>
</code></pre></div>
<p>You can see a <strong><a href="http://bl.ocks.org/nolanlawson/dcdeae555b31c2a6d332">live example</a></strong> of this code.</p>

<div id='seq-versus-rev'></div>

<p><a class='h2 anchor' href='#seq-versus-rev' name='seq-versus-rev'>
<code>seq</code> versus <code>_rev</code>
</a></p>

<p>The changes feed lists each change with a corresponding <code>seq</code> integer. <code>seq</code> always starts with 0, and beyond that it increases monotonically. (In Cloudant, these are strings rather than integers.)</p>

<p><code>seq</code> can be thought of as a version number for the entire database. Basically it answers the question of &quot;How many total changes have been made to all documents in this database?&quot; This sets it apart from the revision hash <code>_rev</code>, which marks the changes made to a single document.</p>

<p>However, the <code>seq</code> between two databases is not guaranteed to be kept in sync. CouchDB and PouchDB have slightly different ways of increasing their <code>seq</code> values, so really <code>seq</code> is only meaningful within a single database.</p>

<div id='live-changes-feed'></div>

<p><a class='h2 anchor' href='#live-changes-feed' name='live-changes-feed'>
Live changes feed
</a></p>

<p>Just like replication, you can also listen to a live changes feed. The way this works is very similar to the replication API:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">db</span><span class="p">.</span><span class="nx">changes</span><span class="p">({</span>
  <span class="nx">since</span><span class="o">:</span> <span class="s1">&#39;now&#39;</span>
<span class="p">}).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">change</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// received a change</span>
<span class="p">}).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// handle errors</span>
<span class="p">});</span>
</code></pre></div>
<p>In the above example, we&#39;ve also taken advantage of the quasi-magical <code>&#39;now&#39;</code> option for <code>since</code>, which will give us all changes from the moment we start listening.</p>

<p>This can be very useful for scenarios where you want to update the UI whenever something in the database changes, such as for a real-time chat application.</p>

<div id='understanding-changes'></div>

<p><a class='h2 anchor' href='#understanding-changes' name='understanding-changes'>
Understanding changes
</a></p>

<p>There are two types of changes:</p>

<ul>
<li>Added or modified documents</li>
<li>Deleted documents</li>
</ul>

<p>To distinguish between the two types in a live <code>changes()</code> listener,
you can use the following code:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">db</span><span class="p">.</span><span class="nx">changes</span><span class="p">({</span>
  <span class="nx">since</span><span class="o">:</span> <span class="s1">&#39;now&#39;</span><span class="p">,</span>
  <span class="nx">live</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="nx">include_docs</span><span class="o">:</span> <span class="kc">true</span>
<span class="p">}).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">change</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// change.id contains the doc id, change.doc contains the doc</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">change</span><span class="p">.</span><span class="nx">deleted</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// document was deleted</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// document was added/modified</span>
  <span class="p">}</span>
<span class="p">}).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// handle errors</span>
<span class="p">});</span>
</code></pre></div>
<p>You can see a <a href="http://bl.ocks.org/nolanlawson/fa42662cdfeeaa7b78fc">live example</a> of this code.</p>

<p>Notice that <code>change.doc</code> contains the document (unless it&#39;s deleted), because we used <code>{include_docs: true}</code>.</p>

<p>Also notice that new documents always have revisions starting with the string <code>&#39;1-&#39;</code>. Subsequent revisions start with <code>&#39;2-&#39;</code>, <code>&#39;3-&#39;</code>, <code>&#39;4-&#39;</code>, etc.</p>

<div class="alert alert-info">


<div class="alert-text">


<p><strong>How can I distinguish between added and modified documents?</strong> Checking if the revision starts with <code>'1-'</code> is a pretty good trick. However, this will not work for databases that are replication targets, because replication only sends the latest versions of documents. This means that the <code>'1-'</code> revision may get skipped entirely, and the local database will only receive the 2nd, 3rd or 4th (etc.) revision. Conflicting revisions will also appear in the changes feed.</p>

<p>So the short answer is that you cannot. If you are trying to mirror changes in a non-Pouch structure (e.g. a list of DOM elements), then the best solution is to search all the DOM elements to see if the document already exists, or to re-run <code>allDocs()</code> for every change.</p>

</div></div>

<div id='related-api-documentation'></div>

<p><a class='h2 anchor' href='#related-api-documentation' name='related-api-documentation'>
Related API documentation
</a></p>

<ul>
<li><a href="/api.html#changes">changes()</a></li>
</ul>

<div id='next'></div>

<p><a class='h2 anchor' href='#next' name='next'>
Next
</a></p>

<p>Now that we know how to hook our data spigot to the changes feed, let&#39;s look into using the very powerful <code>query()</code> API.</p>




    

    

    

    

    

    

    

    

    

    

    

    
        
        

        <ul class="pager">
            
                <li class="previous">
                    <a href="/guides/conflicts.html">&larr; Conflicts</a>
                </li>
            
            
                <li class="next">
                    <a href="/guides/queries.html">Map/reduce queries &rarr;</a>
                </li>
            
        </ul>
    

    

    

    


        <div>

    </div>

  </div>

</article>

    </div>

    <div class="icons">

      <div class="container">

        <div class="row">

          <div class='col-xs-4 col-md-offset-0 col-md-2'>
            <a href='https://twitter.com/pouchdb' target='_blank'>
              <div class="icon icon-twitter"></div>
              <span class="sr-only">PouchDB's Twitter</span>
            </a>
          </div>

          <div class='col-xs-4 col-md-2'>
            <a href='https://github.com/rvagg/node-levelup' target='_blank'>
              <div class="icon icon-leveldb"></div>
              <span class="sr-only">Node Levelup</span>
            </a>
          </div>

          <div class='col-xs-4 col-md-2'>
            <a href='https://github.com/pouchdb/pouchdb' target='_blank'>
              <div class="icon icon-github"></div>
              <span class="sr-only">PouchDB's Github Repo</span>
            </a>
            </div>

          <div class='col-xs-4 col-md-offset-0 col-md-2'>
            <a href='https://travis-ci.org/pouchdb/pouchdb' target='_blank'>
              <div class="icon icon-travis"></div>
              <span class="sr-only">PouchDB's Travis CI</span>
            </a>
          </div>

          <div class='col-xs-4 col-md-2'>
            <a href='http://couchdb.apache.org/' target='_blank'>
              <div class="icon icon-couchdb"></div>
              <span class="sr-only">CouchDB</span>
            </a>
          </div>

          <div class='col-xs-4 col-md-2'>
            <a href='https://saucelabs.com' target='_blank'>
              <div class="icon icon-saucelabs"></div>
              <span class="sr-only">Saucelabs</span>
            </a>
          </div>

        </div>

      </div>

    </div>

    <footer class="footer">

      <div class="container">

        <div class="row">

          <div class='col-sm-3'>
            <h3 class="nav-head">Learn</h3>
            <ul class='nav nav-silent'>
              <li><a href="/getting-started.html">Getting Started</a></li>
              <li><a href="/api.html">API Guide</a></li>
              <li><a href="https://github.com/pouchdb/pouchdb/wiki">Wiki</a></li>
            </ul>
          </div>

          <div class='col-sm-3'>
            <h3 class="nav-head">Discuss</h3>
            <ul class='nav nav-silent'>
              <li><a href="https://groups.google.com/forum/#!forum/pouchdb">Mailing List</a></li>
              <li><a href="irc://freenode.net/#pouchdb">IRC</a></li>
              <li><a href="http://twitter.com/pouchdb">Twitter</a></li>
              <li><a href="http://stackoverflow.com/questions/tagged/pouchdb">StackOverflow</a></li>
            </ul>
          </div>

          <div class='col-sm-3'>
            <h3 class="nav-head">Contribute</h3>
            <ul class='nav nav-silent'>
              <li><a href="https://github.com/pouchdb/pouchdb/blob/master/CONTRIBUTING.md">Contributing</a></li>
              <li><a href="https://github.com/pouchdb/pouchdb">Source</a></li>
              <li><a href="https://github.com/pouchdb/pouchdb/issues">Issues</a></li>
              <li><a href="https://github.com/pouchdb/pouchdb/blob/master/LICENSE">Apache License</a></li>
            </ul>
          </div>

        </div>

      </div>

    </footer>
    <script type="text/javascript" src="http://code.jquery.com/jquery.min.js"></script>
    <script type="text/javascript" src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/static/js/code.min.js"></script>
    <script type="text/javascript" src="/static/js/stickyfill.min.js"></script>
    <script type="text/javascript" src="http://cdn.jsdelivr.net/pouchdb/latest/pouchdb.min.js"></script>
    <script type="text/javascript">
      var $navSidebarWrapper = $('.nav-sidebar-wrapper');
      if ($navSidebarWrapper.length) {
        $navSidebarWrapper.Stickyfill();
      }
      $('[data-toggle="tooltip"]').tooltip();
      function onCached(e) {
        if (applicationCache.status === 1) {
          giveIntro();
        }
      }

      function giveIntro() {
        console.log('%c\n..............................................................................\n.?I...........~+: ............................................................\n.???.........++++.............................................................\n:????+......+++++.............................................................\n.??????+++++++++:.................................H...........D..B............\n...????++++++++...................................H...........D..B............\n...=????++++++.......PPPPP...OOOO...U....U...CCCC.HHHHH...DDDDD..BBBBB........\n...?????+++++++......P...:P.OO...O..U....U..C.....H...H..D....D..B....B.......\n..???????+++++++ ....P. ..P.O....O..U....U.CC.....H...H..D....D..B....B.......\n..?????????????......P...:P.OO...O..U....U..C.....H...H..D....D..B....B.......\n...I??????????~......PPPPP...OOOO...=UUUUU...CCCC.H...H...DDDDD..BBBBB........\n....?????????~.......P.... ...................................................\n.....???????+........P........................................................\n......??????..................................................................\n..............................................................................\n..............................................................................\n..............................................................................', 'color: #4ec084');
        console.log('%c\nPouchDB itself is hosted at PouchDB.com!\nTo get started, try typing:\nvar db = new PouchDB(\'mydb\');', 'color: #4ec084');
      }
      function offerToReload() {
        $('.js-update-notification')
          .removeClass('btn-update-hidden')
          .on('click', function(){
            window.location.reload();
          });
      }
      if (window.applicationCache) {
        applicationCache.addEventListener('cached', onCached, false);
        applicationCache.addEventListener('noupdate', giveIntro, false);
        applicationCache.addEventListener('updateready', offerToReload, false);
      }
    </script>
    <button type="button" class="js-update-notification btn btn-primary btn-update btn-update-hidden">
      Content updated, reload now? ↻
    </button>
  </body>
</html>
